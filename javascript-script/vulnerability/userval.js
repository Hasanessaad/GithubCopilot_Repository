/**
 * Funções para validar e sanitizar entradas do usuário antes de inserir no DOM (prevenção básica de XSS).
 * Uso recomendado:
 *  - Para conteúdo: use insertSafeText(container, userInput)
 *  - Para atributos URL (href/src): use setSafeAttribute(el, 'href', userInput)
 */

/* Escape de entidades HTML */
function escapeHtml(str) {
    return String(str).replace(/[&<>"'`=\/]/g, function (s) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;',
            '`': '&#96;',
            '=': '&#61;'
        }[s];
    });
}

/* Validação básica de string */
function validateString(input, { required = true, maxLength = 2000, pattern = null } = {}) {
    if (typeof input !== 'string') {
        throw new TypeError('Valor deve ser uma string');
    }
    const s = input.trim();
    if (required && s.length === 0) {
        throw new RangeError('String não pode ser vazia');
    }
    if (maxLength !== null && s.length > maxLength) {
        throw new RangeError(`Tamanho máximo excedido (${maxLength})`);
    }
    if (pattern && !pattern.test(s)) {
        throw new RangeError('Formato inválido');
    }
    return s;
}

/* Sanitiza/valida URLs (bloqueia javascript: e protocolos não permitidos) */
function sanitizeUrl(raw, { allowedProtocols = ['http:', 'https:', 'mailto:'] } = {}) {
    if (typeof raw !== 'string') throw new TypeError('URL deve ser string');
    const s = raw.trim();
    // bloqueia explicitamente javascript:, vbscript:, data: (se desejar)
    const lower = s.toLowerCase();
    if (lower.startsWith('javascript:') || lower.startsWith('vbscript:')) {
        throw new RangeError('Protocolo de URL não permitido');
    }
    try {
        // URL aceita relativos se fornecer base; usamos base para validar protocolo quando absoluto
        const u = new URL(s, 'http://example.invalid');
        if (!allowedProtocols.includes(u.protocol)) {
            throw new RangeError('Protocolo de URL não permitido');
        }
        return u.href;
    } catch (e) {
        // Se não for URL válida, rejeitar
        throw new RangeError('URL inválida');
    }
}

/* Insere texto seguro no DOM: usa textContent (não innerHTML) */
function insertSafeText(containerOrSelector, rawInput, options) {
    const input = validateString(rawInput, options);
    let container = null;
    if (typeof containerOrSelector === 'string') {
        container = document.querySelector(containerOrSelector);
    } else {
        container = containerOrSelector;
    }
    if (!(container instanceof Element)) {
        throw new TypeError('Container DOM inválido');
    }
    container.textContent = input; // textContent evita interpretação HTML
    return container;
}

/* Define atributo de forma segura; para href/src valida URL */
function setSafeAttribute(el, attr, rawValue) {
    if (!(el instanceof Element)) throw new TypeError('Elemento inválido');
    const a = String(attr).toLowerCase();
    if (a === 'href' || a === 'src' || a === 'action') {
        const cleanUrl = sanitizeUrl(String(rawValue));
        el.setAttribute(attr, cleanUrl);
    } else {
        // para outros atributos, validamos e usamos valor direto (setAttribute não interpreta HTML)
        const val = validateString(String(rawValue), { required: false, maxLength: 2000 });
        el.setAttribute(attr, val);
    }
    return el;
}

/* Exemplos de uso (em ambiente browser)
const div = document.createElement('div');
insertSafeText(div, '<script>alert(1)</script>'); // insere texto literal, sem executar
const a = document.createElement('a');
setSafeAttribute(a, 'href', 'https://example.com'); // permitido
// setSafeAttribute(a, 'href', 'javascript:alert(1)'); // lançará erro
*/

module.exports = {
    escapeHtml,
    validateString,
    sanitizeUrl,
    insertSafeText,
    setSafeAttribute
};