const { MongoClient, ObjectId } = require('mongodb');

/**
 * Evita chaves maliciosas (como $ne, $where) e chaves com '.' que podem manipular documentos.
 */
function assertSafeKey(key) {
    if (typeof key !== 'string') throw new TypeError('Chave inválida');
    if (key.startsWith('$') || key.includes('.')) {
        throw new RangeError('Chave de filtro não permitida');
    }
}

/**
 * Escape para uso em RegExp - evita que entrada de usuário forme padrões perigosos.
 */
function escapeRegExp(s) {
    return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Constrói uma query segura a partir de params liberados pela whitelist.
 * allowedFields: { fieldName: 'string'|'number'|'boolean'|'objectId'|'date' }
 */
function buildSafeQuery(params = {}, allowedFields = {}) {
    const q = {};
    for (const key of Object.keys(params)) {
        if (!(key in allowedFields)) {
            // ignorar campos não permitidos em vez de lançar (mais tolerante)
            continue;
        }
        assertSafeKey(key);
        const expected = allowedFields[key];
        const raw = params[key];

        if (expected === 'string') {
            if (typeof raw !== 'string') continue;
            const trimmed = raw.trim();
            if (trimmed.length === 0) continue;
            // usa regex seguro para busca "contains" sem permitir patterns arbitrários
            q[key] = { $regex: escapeRegExp(trimmed), $options: 'i' };
        } else if (expected === 'number') {
            const n = Number(raw);
            if (Number.isFinite(n)) q[key] = n;
        } else if (expected === 'boolean') {
            if (raw === true || raw === false) q[key] = raw;
            else if (raw === 'true') q[key] = true;
            else if (raw === 'false') q[key] = false;
        } else if (expected === 'objectId') {
            try {
                q[key] = new ObjectId(String(raw));
            } catch (e) {
                // id inválido -> ignora
                continue;
            }
        } else if (expected === 'date') {
            const d = new Date(raw);
            if (!Number.isNaN(d.getTime())) q[key] = d;
        }
    }
    return q;
}

/**
 * Conecta e retorna client (caller fecha com client.close()).
 */
async function connect(uri, options = {}) {
    if (typeof uri !== 'string') throw new TypeError('URI deve ser string');
    const client = new MongoClient(uri, { useUnifiedTopology: true, ...options });
    await client.connect();
    return client;
}

/**
 * Busca por _id de forma segura (valida ObjectId).
 */
async function findById(db, collectionName, id, projection = {}) {
    if (!db || !collectionName || !id) throw new TypeError('Parâmetros inválidos');
    let _id;
    try {
        _id = new ObjectId(String(id));
    } catch (e) {
        return null; // id inválido -> não lança exceções que vazem detalhes
    }
    const coll = db.collection(collectionName);
    return coll.findOne({ _id }, { projection });
}

/**
 * Busca segura com whitelist de campos e paginação simples.
 * params: objeto proveniente de usuário (req.query por ex.)
 * allowedFields: mapa de campos permitidos e seus tipos (veja buildSafeQuery)
 * options: { projection, limit, skip, sort }
 */
async function safeFind(db, collectionName, params = {}, allowedFields = {}, options = {}) {
    if (!db || !collectionName) throw new TypeError('Parâmetros inválidos');
    const coll = db.collection(collectionName);
    const query = buildSafeQuery(params, allowedFields);
    const limit = Math.min(Math.max(Number(options.limit) || 20, 1), 100); // 1..100
    const skip = Math.max(Number(options.skip) || 0, 0);
    const cursor = coll.find(query, { projection: options.projection || {} }).skip(skip).limit(limit);
    if (options.sort) cursor.sort(options.sort);
    return cursor.toArray();
}

/**
 * Exemplos de uso:
 *
 * (async () => {
 *   const client = await connect(process.env.MONGO_URI);
 *   const db = client.db('mydb');
 *
 *   // Whitelist de campos permitidos na busca (tipos esperados)
 *   const allowed = { name: 'string', age: 'number', active: 'boolean', _id: 'objectId' };
 *
 *   // Busca segura com params vindos do usuário (por ex: req.query)
 *   const results = await safeFind(db, 'users', { name: 'joão', age: '30' }, allowed, { limit: 10 });
 *   console.log(results);
 *
 *   const one = await findById(db, 'users', '64b8f...'); // id vindo do usuário
 *   console.log(one);
 *
 *   await client.close();
 * })().catch(err => {
 *   console.error('erro:', err);
 * });
 */

module.exports = {
    connect,
    buildSafeQuery,
    safeFind,
    findById
};