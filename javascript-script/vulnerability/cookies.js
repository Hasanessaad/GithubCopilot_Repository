/**
 * Helpers para configurar cookies de autenticação seguros (HttpOnly, Secure, SameSite).
 * Uso: setAuthCookie(res, token, req) / clearAuthCookie(res, req)
 */

const DEFAULT_COOKIE_NAME = 'auth_token';

function _isProductionSecure(req) {
    // Em produção, force secure.
    if (process.env.NODE_ENV === 'production') return true;
    // Em dev, tenta detectar conexão segura via Express (req.secure) ou proxy (x-forwarded-proto)
    if (req && typeof req.secure === 'boolean') {
        if (req.secure) return true;
    }
    if (req && req.headers && typeof req.headers['x-forwarded-proto'] === 'string') {
        return req.headers['x-forwarded-proto'].split(',')[0].trim().toLowerCase() === 'https';
    }
    return false;
}

/**
 * Retorna opções seguras para cookie de autenticação.
 * Por padrão:
 *  - httpOnly: true  (impede acesso via JS)
 *  - secure: true em produção ou se conexão for HTTPS detectada
 *  - sameSite: 'Lax' (pode usar 'Strict' conforme necessidade)
 */
function getCookieOptions(req = null, { maxAge = 7 * 24 * 60 * 60 * 1000, sameSite = 'Lax', path = '/', domain = undefined, httpOnly = true, secure = undefined } = {}) {
    const inferredSecure = _isProductionSecure(req);
    // allow explicit override, mas force true em produção/inferido
    const finalSecure = process.env.NODE_ENV === 'production' ? true : (secure === undefined ? inferredSecure : Boolean(secure));
    const opts = { httpOnly: Boolean(httpOnly), secure: Boolean(finalSecure), sameSite, maxAge, path };
    if (domain) opts.domain = domain;
    return opts;
}

/**
 * Define cookie de autenticação seguro.
 * - res: objeto Express response
 * - token: string (por ex. JWT ou session id)
 * - req: request (opcional) usado para inferir secure
 * - options: passthrough para getCookieOptions
 */
function setAuthCookie(res, token, req = null, options = {}) {
    if (!res || typeof res.cookie !== 'function') throw new TypeError('res deve ser um objeto Express response');
    if (typeof token !== 'string' || token.length === 0) throw new TypeError('token inválido');
    const opts = getCookieOptions(req, options);
    // Garante flags essenciais
    opts.httpOnly = true;
    if (process.env.NODE_ENV === 'production') opts.secure = true;
    res.cookie(DEFAULT_COOKIE_NAME, token, opts);
    return res;
}

/**
 * Remove cookie de autenticação (invalida no cliente).
 */
function clearAuthCookie(res, req = null, options = {}) {
    if (!res || typeof res.clearCookie !== 'function') throw new TypeError('res deve ser um objeto Express response');
    const opts = getCookieOptions(req, options);
    // clearCookie deve usar mesmas flags (path/domain/secure)
    res.clearCookie(DEFAULT_COOKIE_NAME, opts);
    return res;
}

/* Exemplo mínimo com Express:
const express = require('express');
const app = express();
app.use(express.json());

app.post('/login', async (req, res) => {
  // autenticar usuário e gerar token (JWT/session id)
  const token = 'SEU_TOKEN_AQUI';
  setAuthCookie(res, token, req, { maxAge: 24*60*60*1000, sameSite: 'Strict' });
  return res.json({ ok: true });
});

app.post('/logout', (req, res) => {
  clearAuthCookie(res, req);
  return res.json({ ok: true });
});
*/

module.exports = {
    setAuthCookie,
    clearAuthCookie,
    getCookieOptions
};